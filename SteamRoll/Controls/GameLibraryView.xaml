<UserControl x:Class="SteamRoll.Controls.GameLibraryView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:SteamRoll.Controls"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             mc:Ignorable="d"
             d:DesignHeight="500" d:DesignWidth="1200">
    <UserControl.Resources>
        <!-- Import resources from MainWindow or define local ones if they are specific -->
        <!-- Since resources like BooleanToHeartConverter are application-wide or window-wide,
             we assume they are available or we might need to redefine them locally if scoped incorrectly.
             Ideally, common resources should be in App.xaml. For now, we rely on Window resources or App.xaml. -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <local:BooleanToHeartConverter x:Key="BooleanToHeartConverter"/>

        <!-- Skeleton Card Style (copied from MainWindow) -->
        <Style x:Key="SkeletonCardStyle" TargetType="Border">
            <Setter Property="Background" Value="#21262D"/>
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Height" Value="240"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#30363D"/>
            <Setter Property="Opacity" Value="0.5"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <!-- Empty State (shown when no games) -->
        <Border x:Name="EmptyStatePanel" Visibility="Collapsed" VerticalAlignment="Center" HorizontalAlignment="Center">
            <StackPanel>
                <TextBlock Text="ðŸŽ®" FontSize="64" FontFamily="Segoe UI Emoji" HorizontalAlignment="Center" Opacity="0.5" Foreground="{DynamicResource TextPrimaryBrush}"/>
                <TextBlock x:Name="EmptyStateTitle" Text="No Games Found" FontSize="20" FontWeight="SemiBold"
                           Foreground="{DynamicResource TextPrimaryBrush}" HorizontalAlignment="Center" Margin="0,16,0,8"/>
                <TextBlock x:Name="EmptyStateMessage" Text="Try adjusting your filters or adding Steam library paths in Settings."
                           FontSize="13" Foreground="{DynamicResource TextSecondaryBrush}"
                           HorizontalAlignment="Center" TextAlignment="Center" MaxWidth="400"/>
                <Button x:Name="EmptyStateRefreshBtn" Click="RefreshButton_Click" Margin="0,24,0,0"
                        Style="{DynamicResource PrimaryButton}">
                    <StackPanel Orientation="Horizontal">
                        <Path Fill="White" Data="{StaticResource IconRefreshReal}" Width="14" Height="14" Stretch="Uniform" Margin="0,0,8,0"/>
                        <TextBlock Text="Refresh Library"/>
                    </StackPanel>
                </Button>
            </StackPanel>
        </Border>

        <!-- Skeleton View (Loading State) -->
        <ScrollViewer x:Name="SkeletonView" VerticalScrollBarVisibility="Hidden" Padding="24,16" Visibility="Collapsed">
             <ScrollViewer.Resources>
                 <Style TargetType="ScrollBar" BasedOn="{StaticResource DarkScrollBarStyle}"/>
             </ScrollViewer.Resources>
             <ItemsControl>
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <UniformGrid Columns="5"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemsSource>
                    <x:Array Type="{x:Type sys:String}">
                         <sys:String>1</sys:String><sys:String>2</sys:String><sys:String>3</sys:String><sys:String>4</sys:String><sys:String>5</sys:String>
                         <sys:String>6</sys:String><sys:String>7</sys:String><sys:String>8</sys:String><sys:String>9</sys:String><sys:String>10</sys:String>
                         <sys:String>11</sys:String><sys:String>12</sys:String><sys:String>13</sys:String><sys:String>14</sys:String><sys:String>15</sys:String>
                    </x:Array>
                </ItemsControl.ItemsSource>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                         <Border Style="{StaticResource SkeletonCardStyle}" Margin="8">
                             <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="90"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                <Border Grid.Row="0" Background="#30363D" CornerRadius="10,10,0,0"/>
                                <StackPanel Grid.Row="1" Margin="14">
                                    <Border Height="18" Width="120" Background="#30363D" CornerRadius="4" HorizontalAlignment="Left" Margin="0,0,0,8"/>
                                    <Border Height="12" Width="60" Background="#30363D" CornerRadius="4" HorizontalAlignment="Left" Margin="0,0,0,16"/>
                                    <StackPanel Orientation="Horizontal">
                                        <Border Height="20" Width="60" Background="#30363D" CornerRadius="4" Margin="0,0,8,0"/>
                                        <Border Height="20" Width="40" Background="#30363D" CornerRadius="4"/>
                                    </StackPanel>
                                    <Border Height="36" Background="#30363D" CornerRadius="6" VerticalAlignment="Bottom" Margin="0,30,0,0"/>
                                </StackPanel>
                                <!-- Pulse Animation trigger -->
                                <Grid.Triggers>
                                    <EventTrigger RoutedEvent="Loaded">
                                        <BeginStoryboard>
                                            <Storyboard RepeatBehavior="Forever" AutoReverse="True">
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0.3" To="0.7" Duration="0:0:1"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                </Grid.Triggers>
                            </Grid>
                         </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
             </ItemsControl>
        </ScrollViewer>

        <!-- Game List (Grid View) -->
        <ScrollViewer x:Name="GamesGridScroll" VerticalScrollBarVisibility="Auto" Padding="24,16">
            <ScrollViewer.Resources>
                <Style TargetType="ScrollBar" BasedOn="{StaticResource DarkScrollBarStyle}"/>
            </ScrollViewer.Resources>
            <ItemsControl x:Name="GamesList">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Style="{DynamicResource GameCard}" Margin="8" Cursor="Hand"
                                MouseLeftButtonUp="GameCard_Click" Tag="{Binding}"
                                ClipToBounds="True" Width="240" MaxHeight="340" VerticalAlignment="Top">
                            <Border.Triggers>
                                <EventTrigger RoutedEvent="Loaded">
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.3"/>
                                            <ThicknessAnimation Storyboard.TargetProperty="Margin" From="8,20,8,0" To="8,8,8,8" Duration="0:0:0.3" DecelerationRatio="0.5"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </EventTrigger>
                            </Border.Triggers>
                            <!-- Context Menu for game cards -->
                            <Border.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="â¤ï¸ Toggle Favorite" Click="ContextMenu_Favorite_Click" Tag="{Binding}"/>
                                    <MenuItem Header="ðŸ’¾ Backup Save" Click="ContextMenu_BackupSave_Click" Tag="{Binding}"/>
                                    <Separator/>
                                    <MenuItem Header="ðŸ“¦ Create Package" Click="ContextMenu_Package_Click" Tag="{Binding}">
                                        <MenuItem.Style>
                                            <Style TargetType="MenuItem">
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding IsPackaged}" Value="True">
                                                        <Setter Property="Header" Value="ðŸ“‚ Open"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </MenuItem.Style>
                                    </MenuItem>
                                    <MenuItem Header="ðŸ—‘ï¸ Delete Package" Click="ContextMenu_DeletePackage_Click" Tag="{Binding}">
                                        <MenuItem.Style>
                                            <Style TargetType="MenuItem">
                                                <Setter Property="IsEnabled" Value="{Binding IsPackaged}"/>
                                            </Style>
                                        </MenuItem.Style>
                                    </MenuItem>
                                    <MenuItem Header="ðŸ”„ Update Package" Click="ContextMenu_UpdatePackage_Click" Tag="{Binding}"
                                              ToolTip="Update package with latest Steam files">
                                        <MenuItem.Style>
                                            <Style TargetType="MenuItem">
                                                <Setter Property="IsEnabled" Value="{Binding UpdateAvailable}"/>
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding UpdateAvailable}" Value="True">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </MenuItem.Style>
                                    </MenuItem>
                                    <Separator/>
                                    <MenuItem Header="ðŸ“¤ Send to Peer" Click="ContextMenu_SendToPeer_Click" Tag="{Binding}">
                                        <MenuItem.Style>
                                            <Style TargetType="MenuItem">
                                                <Setter Property="IsEnabled" Value="{Binding IsPackaged}"/>
                                            </Style>
                                        </MenuItem.Style>
                                    </MenuItem>
                                    <MenuItem Header="ðŸ”„ Sync Saves with Peer" Click="ContextMenu_SyncSaves_Click" Tag="{Binding}"/>
                                    <MenuItem Header="âš™ï¸ Advanced Config" Click="ContextMenu_AdvancedConfig_Click" Tag="{Binding}"
                                              ToolTip="Configure Goldberg emulator settings">
                                        <MenuItem.Style>
                                            <Style TargetType="MenuItem">
                                                <Setter Property="IsEnabled" Value="{Binding IsPackageable}"/>
                                            </Style>
                                        </MenuItem.Style>
                                    </MenuItem>
                                    <Separator/>
                                    <MenuItem Header="ðŸ“ Open Install Folder" Click="ContextMenu_OpenInstallFolder_Click" Tag="{Binding}"/>
                                    <MenuItem Header="ðŸ” View Details" Click="ContextMenu_ViewDetails_Click" Tag="{Binding}"/>
                                    <MenuItem Header="ðŸ›¡ï¸ Verify Integrity" Click="ContextMenu_VerifyIntegrity_Click" Tag="{Binding}">
                                        <MenuItem.Style>
                                            <Style TargetType="MenuItem">
                                                <Setter Property="IsEnabled" Value="{Binding IsPackaged}"/>
                                            </Style>
                                        </MenuItem.Style>
                                    </MenuItem>
                                    <MenuItem Header="ðŸ”§ Repair from Peer" Click="ContextMenu_RepairFromPeer_Click" Tag="{Binding}"
                                              ToolTip="Pull missing/corrupt files from a peer">
                                        <MenuItem.Style>
                                            <Style TargetType="MenuItem">
                                                <Setter Property="IsEnabled" Value="{Binding IsPackaged}"/>
                                            </Style>
                                        </MenuItem.Style>
                                    </MenuItem>
                                        <MenuItem Header="ðŸŒ Open Steam Store" Click="ContextMenu_OpenSteamStore_Click" Tag="{Binding}"/>
                                    </ContextMenu>
                            </Border.ContextMenu>
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="90"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <!-- Row 0: Header Image with overlay -->
                                <Grid Grid.Row="0" x:Name="HeaderImageContainer">
                                    <!-- Placeholder icon when no image loads -->
                                    <Border Background="#21262D">
                                        <TextBlock Text="ðŸŽ®" FontSize="32"
                                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                                   FontFamily="Segoe UI Emoji" Foreground="#6E7681"/>
                                    </Border>

                                    <!-- Game Header Image with rounded top corners -->
                                    <Border CornerRadius="10,10,0,0" Style="{DynamicResource HeaderImageBorderStyle}">
                                        <Border.Background>
                                            <ImageBrush ImageSource="{Binding HeaderImageUrl}" Stretch="UniformToFill"/>
                                        </Border.Background>
                                    </Border>

                                    <!-- Dark gradient overlay for text readability -->
                                    <Border CornerRadius="10,10,0,0">
                                        <Border.Background>
                                            <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                                <GradientStop Color="#00000000" Offset="0"/>
                                                <GradientStop Color="#AA0D1117" Offset="0.7"/>
                                                <GradientStop Color="#FF0D1117" Offset="1"/>
                                            </LinearGradientBrush>
                                        </Border.Background>
                                    </Border>

                                    <!-- Selection checkbox (top left) -->
                                    <CheckBox HorizontalAlignment="Left" VerticalAlignment="Top" Margin="8,8,0,0"
                                              IsChecked="{Binding IsSelected, Mode=TwoWay}"
                                              Click="GameSelection_Click"
                                              Tag="{Binding}"
                                              Style="{DynamicResource SelectionCheckboxStyle}"/>

                                    <!-- Compatibility indicator (top right) -->
                                    <Ellipse Width="12" Height="12" Margin="0,8,8,0"
                                             HorizontalAlignment="Right" VerticalAlignment="Top"
                                             Style="{DynamicResource CompatDotStyle}"/>

                                    <!-- Favorite Toggle (Bottom Right of Image) -->
                                    <ToggleButton HorizontalAlignment="Right" VerticalAlignment="Bottom" Margin="0,0,8,8"
                                                  IsChecked="{Binding IsFavorite, Mode=TwoWay}"
                                                  Click="FavoriteToggle_Click"
                                                  Tag="{Binding}"
                                                  Cursor="Hand"
                                                  Style="{DynamicResource FavoriteToggleStyle}">
                                        <ToggleButton.Template>
                                            <ControlTemplate TargetType="ToggleButton">
                                                <TextBlock x:Name="HeartIcon" Text="ðŸ¤" FontSize="16" Effect="{DynamicResource DropShadowEffect}"/>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsChecked" Value="True">
                                                        <Setter TargetName="HeartIcon" Property="Text" Value="â¤ï¸"/>
                                                    </Trigger>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="HeartIcon" Property="Opacity" Value="0.8"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </ToggleButton.Template>
                                    </ToggleButton>
                                </Grid>


                            <!-- Row 1: Content area -->
                            <Grid Grid.Row="1" Margin="14,10,14,14">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                            <!-- Game Name -->
                            <TextBlock Grid.Row="0" Text="{Binding Name}"
                                       FontSize="15" FontWeight="SemiBold"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       TextTrimming="CharacterEllipsis"/>

                            <!-- Row 1: DRM Type and Last Played (side by side) -->
                            <Grid Grid.Row="1" Margin="0,4,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" FontSize="11" Style="{DynamicResource DrmTypeTextStyle}"/>
                                <TextBlock Grid.Column="1" Text="{Binding FormattedLastPlayed}" FontSize="12"
                                           Foreground="{DynamicResource TextMutedBrush}"
                                           HorizontalAlignment="Right" VerticalAlignment="Center"/>
                            </Grid>

                            <!-- Row 2: Size and DLC Info Badges -->
                            <WrapPanel Grid.Row="2" Margin="0,12,0,0">
                                <!-- Size Badge -->
                                <Border Background="#21262D" CornerRadius="4" Padding="8,4" Margin="0,0,8,4">
                                    <TextBlock Text="{Binding FormattedSize}" FontSize="11"
                                               Foreground="{DynamicResource TextSecondaryBrush}"/>
                                </Border>

                                <!-- DLC Badge (only if HasDlc) -->
                                <Border CornerRadius="4" Padding="8,4" Margin="0,0,8,4" Style="{DynamicResource DlcBadgeBorderStyle}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="ðŸŽ" FontSize="10" Margin="0,0,4,0" FontFamily="Segoe UI Emoji"/>
                                        <TextBlock Text="{Binding DlcSummary}"
                                                   FontSize="11" Foreground="#A371F7"/>
                                    </StackPanel>
                                </Border>

                                <!-- Metacritic Badge -->
                                <Border Background="#21262D" CornerRadius="4" Padding="8,4" Margin="0,0,8,4"
                                        Visibility="{Binding HasMetacriticScore, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="Metacritic" FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}" Margin="0,0,4,0"/>
                                        <TextBlock Text="{Binding MetacriticScore}" FontSize="11" FontWeight="Bold" Foreground="{Binding MetacriticScoreColor}"/>
                                    </StackPanel>
                                </Border>

                                <!-- Steam Review Badge -->
                                <Border Background="#21262D" CornerRadius="4" Padding="8,4" Margin="0,0,8,4"
                                        Visibility="{Binding HasReviewScore, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="â­" FontSize="10" Margin="0,0,4,0" FontFamily="Segoe UI Emoji" Foreground="{Binding ReviewScoreColor}"/>
                                        <TextBlock Text="{Binding ReviewPositivePercent, StringFormat='{}{0}%'}" FontSize="11" FontWeight="Bold" Foreground="{Binding ReviewScoreColor}"/>
                                    </StackPanel>
                                </Border>

                                <!-- Packaged Badge (shows different for received packages) -->
                                <Border CornerRadius="4" Padding="8,4" Margin="0,0,8,4" Style="{DynamicResource PackagedBadgeBorderStyle}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock FontSize="10" Margin="0,0,4,0" Style="{DynamicResource PackagedIconTextStyle}"/>
                                        <TextBlock FontSize="11" Style="{DynamicResource PackagedLabelTextStyle}"/>
                                    </StackPanel>
                                </Border>

                                <!-- Update Available Button (clickable) -->
                                <Button Click="UpdatePackageButton_Click"
                                        Tag="{Binding}"
                                        Cursor="Hand"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Padding="0"
                                        Margin="0,0,8,4"
                                        ToolTip="Click to update package with latest Steam files">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding UpdateAvailable}" Value="True">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                    <Border CornerRadius="4" Padding="8,4" Background="#3D2E12" BorderBrush="#D29922" BorderThickness="1">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="ðŸ”„" FontSize="10" Margin="0,0,4,0" FontFamily="Segoe UI Emoji"/>
                                            <TextBlock Text="Update" FontSize="11" Foreground="#D29922" FontWeight="SemiBold"/>
                                        </StackPanel>
                                    </Border>
                                </Button>

                                <!-- Status Badge (simplified) -->
                                <Border CornerRadius="4" Padding="8,4" Margin="0,0,0,4" Style="{DynamicResource ReadyBadgeBorderStyle}">
                                    <TextBlock Text="Ready" FontSize="11" Foreground="{DynamicResource SuccessBrush}"/>
                                </Border>

                                <!-- Network Available Badge -->
                                <Border CornerRadius="4" Padding="8,4" Margin="0,0,8,4" Background="#1A2A3A"
                                        Visibility="{Binding IsNetworkAvailable, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="ðŸ“¡" FontSize="10" Margin="0,0,4,0" FontFamily="Segoe UI Emoji"/>
                                        <TextBlock Text="Network" FontSize="11" Foreground="#58A6FF"/>
                                    </StackPanel>
                                </Border>
                            </WrapPanel>



                                <!-- Row 3: Actions -->
                            <Grid Grid.Row="3" Margin="0,14,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Package Button -->
                                <Button Grid.Column="0"
                                        Click="PackageButton_Click"
                                        Tag="{Binding}"
                                        IsEnabled="{Binding IsPackageable}"
                                        FontWeight="SemiBold"
                                        Foreground="White"
                                        BorderThickness="0"
                                        Padding="10,10"
                                        Cursor="Hand"
                                        HorizontalAlignment="Stretch"
                                        ToolTip="{Binding FormattedSize, StringFormat='Package size: ~{0}'}"
                                        Style="{DynamicResource PackageButtonStyle}">
                                    <Button.Content>
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock FontSize="13" FontFamily="Segoe UI Emoji" Style="{DynamicResource ButtonIconTextStyle}"/>
                                            <TextBlock FontSize="12" Style="{DynamicResource ButtonLabelTextStyle}"/>
                                        </StackPanel>
                                    </Button.Content>
                                </Button>

                                <!-- Send to Peer Button (only when packaged) -->
                                <Button Grid.Column="1"
                                        Style="{DynamicResource SecondaryButton}"
                                        Margin="8,0,0,0"
                                        Click="SendToPeerButton_Click"
                                        Tag="{Binding}"
                                        Padding="12,10"
                                        ToolTip="Send to Peer">
                                    <Button.Visibility>
                                        <Binding Path="IsPackaged">
                                            <Binding.Converter>
                                                <BooleanToVisibilityConverter/>
                                            </Binding.Converter>
                                        </Binding>
                                    </Button.Visibility>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="ðŸ“¤" FontSize="13" FontFamily="Segoe UI Emoji" Margin="0,0,4,0"/>
                                        <TextBlock Text="Send" FontSize="12" FontWeight="SemiBold"/>
                                    </StackPanel>
                                </Button>

                                <!-- Install from Peer Button (only when available on network but not locally packaged) -->
                                <Button Grid.Column="1"
                                        Margin="8,0,0,0"
                                        Click="InstallFromPeerButton_Click"
                                        Tag="{Binding}"
                                        Padding="12,10"
                                        ToolTip="Download from a peer on the network"
                                        Visibility="{Binding CanInstallFromPeer, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <Button.Style>
                                        <Style TargetType="Button" BasedOn="{StaticResource AccentPrimaryButton}">
                                            <Setter Property="Background">
                                                <Setter.Value>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                        <GradientStop Color="#1D4ED8" Offset="0"/>
                                                        <GradientStop Color="#2563EB" Offset="1"/>
                                                    </LinearGradientBrush>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </Button.Style>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="ðŸ“¡" FontSize="13" FontFamily="Segoe UI Emoji" Margin="0,0,4,0"/>
                                        <TextBlock Text="Install" FontSize="12" FontWeight="SemiBold" Foreground="White"/>
                                    </StackPanel>
                                </Button>
                            </Grid>
                            </Grid>
                        </Grid>
                    </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- List View (Table) -->
        <ListView x:Name="GamesListView" Visibility="Collapsed"
                  ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                  Background="Transparent" BorderThickness="0"
                  Foreground="{DynamicResource TextPrimaryBrush}"
                  Margin="24,16">
            <ListView.ItemContainerStyle>
                <Style TargetType="ListViewItem">
                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                    <Setter Property="Cursor" Value="Hand"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListViewItem">
                                <Border x:Name="Border" Background="{TemplateBinding Background}"
                                        BorderBrush="{DynamicResource BorderSubtleBrush}" BorderThickness="0,0,0,1"
                                        Padding="8,12">
                                    <GridViewRowPresenter
                                        VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                        HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                        Columns="{Binding Path=View.Columns, RelativeSource={RelativeSource AncestorType={x:Type ListView}}}"/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="Border" Property="Background" Value="#1AFFFFFF"/>
                                    </Trigger>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter TargetName="Border" Property="Background" Value="#2AFFFFFF"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                    <EventSetter Event="MouseLeftButtonUp" Handler="GameCard_Click"/>
                </Style>
            </ListView.ItemContainerStyle>
            <ListView.View>
                <GridView>
                    <GridViewColumn Header="Name" Width="300">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="{Binding IsFavorite, Converter={StaticResource BooleanToHeartConverter}}" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                </StackPanel>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="Size" Width="100">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding FormattedSize}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="Status" Width="120">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding StatusText}" Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="DRM" Width="80">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding PrimaryDrm}" Foreground="{DynamicResource TextMutedBrush}"/>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="Last Played" Width="120">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding FormattedLastPlayed}" Foreground="{DynamicResource TextMutedBrush}"/>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="Updated" Width="100">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding LastUpdated, StringFormat=d}" Foreground="{DynamicResource TextMutedBrush}"/>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="Score" Width="80">
                        <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ReviewPositivePercent, StringFormat={}{0}%}" Foreground="{Binding ReviewScoreColor}" FontWeight="Bold"/>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                    <GridViewColumn Header="Actions" Width="Auto">
                         <GridViewColumn.CellTemplate>
                            <DataTemplate>
                                <Button Content="Package" Click="PackageButton_Click" Tag="{Binding}"
                                        IsEnabled="{Binding IsPackageable}"
                                        Padding="8,4" FontSize="11" Style="{DynamicResource SecondaryButton}"/>
                            </DataTemplate>
                        </GridViewColumn.CellTemplate>
                    </GridViewColumn>
                </GridView>
            </ListView.View>
        </ListView>

        <!-- Batch Action Bar (shows when games are selected) -->
        <Border x:Name="BatchActionBar"
                VerticalAlignment="Bottom"
                HorizontalAlignment="Center"
                Margin="0,0,0,20"
                Visibility="Collapsed">
            <Border.Effect>
                <DropShadowEffect BlurRadius="20" ShadowDepth="5" Opacity="0.5"/>
            </Border.Effect>
            <Border Background="#27272A" CornerRadius="12" Padding="20,12" BorderBrush="#3F3F46" BorderThickness="1">
                <StackPanel Orientation="Horizontal">
                    <TextBlock x:Name="BatchSelectionText" Text="0 games selected"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               FontSize="13" VerticalAlignment="Center" Margin="0,0,20,0"/>

                    <Button x:Name="BatchPackageButton" Click="BatchPackage_Click"
                            Margin="0,0,10,0"
                            Style="{DynamicResource PrimaryButton}">
                        <StackPanel Orientation="Horizontal">
                            <Path Fill="White" Data="{StaticResource IconPackage}" Width="14" Height="14" Stretch="Uniform" Margin="0,0,8,0"/>
                            <TextBlock Text="Package Selected"/>
                        </StackPanel>
                    </Button>

                    <Button x:Name="BatchClearButton" Click="BatchClear_Click"
                            Margin="0,0,10,0"
                            Style="{DynamicResource SecondaryButton}" Background="#3F3F46" Foreground="#E4E4E7" BorderThickness="0">
                        <TextBlock Text="Clear Selection"/>
                    </Button>

                    <Button x:Name="BatchSendBtn" Click="BatchSendToPeer_Click"
                            IsEnabled="False"
                            Style="{DynamicResource AccentPrimaryButton}">
                        <StackPanel Orientation="Horizontal">
                            <Path Fill="White" Data="{StaticResource IconTransfers}" Width="14" Height="14" Stretch="Uniform" Margin="0,0,8,0"/>
                            <TextBlock Text="Send to Peer"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</UserControl>
